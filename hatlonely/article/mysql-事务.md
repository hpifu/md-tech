---
title: mysql 事务
date: 2019-11-06 13:54:36
tags: [mysql, 事务, 隔离级别]
---

## 事务 ACID 特性

- **原子性**（**A**tomicity）: 事务中的所有操作，要么全部成功，要么全部失败回滚到最初状态，不会结束在中间的某个环节
- **一致性**（**C**onsistency）: 事务开始之前和结束之后，数据库的完整性没有被破坏，写入的数据必须完全符合所有的预设约束，触发器，级联回滚等等
- **隔离性**（**I**solation）: 数据库并发事务同时对其数据进行读写和修改，隔离性可以防止并发事务交叉执行而导致数据不一致
- **持久性**（**D**urability）: 事务处理结束后，对数据的修改是永久的，即使系统故障也不会丢失

## 事务的并发问题

- **脏读**: 一个事务读取另一个事务未更新的数据
- **不可重复读**: 一个事务读取同一个行数据两次得到不同的结果
- **幻读**: 两次范围查询，第二次查询出现第一次更多或者更少的数据
- **丢失更新1**: 两个事务同时更新一行数据，其中一个事务撤销时覆盖另一个事务
- **丢失更新2**: 两个事务同时更新一行数据，其中一个事务提交时覆盖另一个事务

## 事务的隔离级别

- **读未提交**（Read uncommitted）: 允许脏读/不可重复读/幻读/丢失更新2；修改数据时加行级共享锁至事务结束
- **读已提交**（Read committed）: 允许不可重复读/幻读/丢失更新2，一个事务只能读取另一个事务已提交的数据；修改数据时加行级排它锁至事务结束
- **可重复读**（Repeatable read）: 允许幻读；读取数据时加行级共享锁至事务结束，修改数据时加行级排它锁至事物结束
- **串行化**（Serializable）: 串行化所有操作；读取数据加表级共享锁，修改数据时加表级排它锁

| 隔离级别 | 脏读 | 不可重复读 | 幻读 | 丢失更新1 | 丢失更新2 |
|----------|------|------------|------|-----------|-----------|
| 读未提交 | ✔    | ✔          | ✔    | ✘         | ✔         |
| 读已提交 | ✘    | ✔          | ✔    | ✘         | ✔         |
| 可重复读 | ✘    | ✘          | ✔    | ✘         | ✘         |
| 串行化   | ✘    | ✘          | ✘    | ✘         | ✘         |

隔离级别越高，越能保证数据库的完整性和一致性，但性能也越差，mysql innodb 引擎默认使用的是可重复读级

## 链接

- 事务的隔离级别: <http://www.zsythink.net/archives/1233/>
- 维基百科 ACID: <https://zh.wikipedia.org/zh-hans/ACID>
